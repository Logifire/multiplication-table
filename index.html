<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplikationstabel</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Add sound effects -->
    <audio id="correctSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="completionSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" type="audio/mpeg">
    </audio>
</head>
<body>
    <h1>Multiplikationstabel 1-10</h1>
    <div id="timer">00:00.00</div>
    <button onclick="toggleCells()">Vis/Skjul Alle Felter</button>
    <div class="game-wrapper">
        <div class="table-container">
            <table id="multiplicationTable">
                <thead>
                    <tr>
                        <th></th>
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                        <th>4</th>
                        <th>5</th>
                        <th>6</th>
                        <th>7</th>
                        <th>8</th>
                        <th>9</th>
                        <th>10</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th><label><input type="checkbox" class="table-checkbox" value="1" checked> 1</label></th>
                        <td class="cell" data-value="1">1</td>
                        <td class="cell" data-value="2">2</td>
                        <td class="cell" data-value="3">3</td>
                        <td class="cell" data-value="4">4</td>
                        <td class="cell" data-value="5">5</td>
                        <td class="cell" data-value="6">6</td>
                        <td class="cell" data-value="7">7</td>
                        <td class="cell" data-value="8">8</td>
                        <td class="cell" data-value="9">9</td>
                        <td class="cell" data-value="10">10</td>
                    </tr>
                    <tr>
                        <th><label><input type="checkbox" class="table-checkbox" value="2" checked> 2</label></th>
                        <td class="cell" data-value="2">2</td>
                        <td class="cell" data-value="4">4</td>
                        <td class="cell" data-value="6">6</td>
                        <td class="cell" data-value="8">8</td>
                        <td class="cell" data-value="10">10</td>
                        <td class="cell" data-value="12">12</td>
                        <td class="cell" data-value="14">14</td>
                        <td class="cell" data-value="16">16</td>
                        <td class="cell" data-value="18">18</td>
                        <td class="cell" data-value="20">20</td>
                    </tr>
                    <tr>
                        <th><label><input type="checkbox" class="table-checkbox" value="3" checked> 3</label></th>
                        <td class="cell" data-value="3">3</td>
                        <td class="cell" data-value="6">6</td>
                        <td class="cell" data-value="9">9</td>
                        <td class="cell" data-value="12">12</td>
                        <td class="cell" data-value="15">15</td>
                        <td class="cell" data-value="18">18</td>
                        <td class="cell" data-value="21">21</td>
                        <td class="cell" data-value="24">24</td>
                        <td class="cell" data-value="27">27</td>
                        <td class="cell" data-value="30">30</td>
                    </tr>
                    <tr>
                        <th><label><input type="checkbox" class="table-checkbox" value="4" checked> 4</label></th>
                        <td class="cell" data-value="4">4</td>
                        <td class="cell" data-value="8">8</td>
                        <td class="cell" data-value="12">12</td>
                        <td class="cell" data-value="16">16</td>
                        <td class="cell" data-value="20">20</td>
                        <td class="cell" data-value="24">24</td>
                        <td class="cell" data-value="28">28</td>
                        <td class="cell" data-value="32">32</td>
                        <td class="cell" data-value="36">36</td>
                        <td class="cell" data-value="40">40</td>
                    </tr>
                    <tr>
                        <th><label><input type="checkbox" class="table-checkbox" value="5" checked> 5</label></th>
                        <td class="cell" data-value="5">5</td>
                        <td class="cell" data-value="10">10</td>
                        <td class="cell" data-value="15">15</td>
                        <td class="cell" data-value="20">20</td>
                        <td class="cell" data-value="25">25</td>
                        <td class="cell" data-value="30">30</td>
                        <td class="cell" data-value="35">35</td>
                        <td class="cell" data-value="40">40</td>
                        <td class="cell" data-value="45">45</td>
                        <td class="cell" data-value="50">50</td>
                    </tr>
                    <tr>
                        <th><label><input type="checkbox" class="table-checkbox" value="6" checked> 6</label></th>
                        <td class="cell" data-value="6">6</td>
                        <td class="cell" data-value="12">12</td>
                        <td class="cell" data-value="18">18</td>
                        <td class="cell" data-value="24">24</td>
                        <td class="cell" data-value="30">30</td>
                        <td class="cell" data-value="36">36</td>
                        <td class="cell" data-value="42">42</td>
                        <td class="cell" data-value="48">48</td>
                        <td class="cell" data-value="54">54</td>
                        <td class="cell" data-value="60">60</td>
                    </tr>
                    <tr>
                        <th><label><input type="checkbox" class="table-checkbox" value="7" checked> 7</label></th>
                        <td class="cell" data-value="7">7</td>
                        <td class="cell" data-value="14">14</td>
                        <td class="cell" data-value="21">21</td>
                        <td class="cell" data-value="28">28</td>
                        <td class="cell" data-value="35">35</td>
                        <td class="cell" data-value="42">42</td>
                        <td class="cell" data-value="49">49</td>
                        <td class="cell" data-value="56">56</td>
                        <td class="cell" data-value="63">63</td>
                        <td class="cell" data-value="70">70</td>
                    </tr>
                    <tr>
                        <th><label><input type="checkbox" class="table-checkbox" value="8" checked> 8</label></th>
                        <td class="cell" data-value="8">8</td>
                        <td class="cell" data-value="16">16</td>
                        <td class="cell" data-value="24">24</td>
                        <td class="cell" data-value="32">32</td>
                        <td class="cell" data-value="40">40</td>
                        <td class="cell" data-value="48">48</td>
                        <td class="cell" data-value="56">56</td>
                        <td class="cell" data-value="64">64</td>
                        <td class="cell" data-value="72">72</td>
                        <td class="cell" data-value="80">80</td>
                    </tr>
                    <tr>
                        <th><label><input type="checkbox" class="table-checkbox" value="9" checked> 9</label></th>
                        <td class="cell" data-value="9">9</td>
                        <td class="cell" data-value="18">18</td>
                        <td class="cell" data-value="27">27</td>
                        <td class="cell" data-value="36">36</td>
                        <td class="cell" data-value="45">45</td>
                        <td class="cell" data-value="54">54</td>
                        <td class="cell" data-value="63">63</td>
                        <td class="cell" data-value="72">72</td>
                        <td class="cell" data-value="81">81</td>
                        <td class="cell" data-value="90">90</td>
                    </tr>
                    <tr>
                        <th><label><input type="checkbox" class="table-checkbox" value="10" checked> 10</label></th>
                        <td class="cell" data-value="10">10</td>
                        <td class="cell" data-value="20">20</td>
                        <td class="cell" data-value="30">30</td>
                        <td class="cell" data-value="40">40</td>
                        <td class="cell" data-value="50">50</td>
                        <td class="cell" data-value="60">60</td>
                        <td class="cell" data-value="70">70</td>
                        <td class="cell" data-value="80">80</td>
                        <td class="cell" data-value="90">90</td>
                        <td class="cell" data-value="100">100</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="gameControls" class="game-controls">
            <button id="gameToggle" onclick="toggleGame()">Start Spillet</button>
            <div id="gameInputGroup" class="game-input-group">
                <span id="question"></span>
                <input type="number" 
                    id="answer" 
                    placeholder="Svar" 
                    onkeydown="handleKeyDown(event)"
                    aria-label="Dit svar">
                <button onclick="checkAnswer()">Tjek</button>
            </div>
            <p id="feedback" role="status" aria-live="polite"></p>
        </div>
    </div>

    <script>
        // Update initial state
        let currentQuestion = {};
        let cellsVisible = true;  // Keep true for initial state
        let timerInterval;
        let startTime;
        let gameActive = false;

        function toggleGame() {
            if (gameActive) {
                stopGame();
                document.getElementById('gameToggle').textContent = 'Start Spillet';
            } else {
                startGame();
                document.getElementById('gameToggle').textContent = 'Stop Spillet';
            }
        }

        function resetGame() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                cell.textContent = cell.getAttribute('data-value');
                cell.classList.remove('hidden-value', 'correct', 'incorrect', 'solved');
            });
            document.getElementById('feedback').textContent = '';
            document.getElementById('question').textContent = '';
            document.getElementById('answer').value = '';
            document.getElementById('timer').textContent = '00:00.00';
            document.getElementById('gameInputGroup').classList.remove('active');
            document.getElementById('gameToggle').textContent = 'Start Spillet';
            gameActive = false;
            cellsVisible = true;
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        function startGame() {
            resetGame(); // Only reset when explicitly starting
            gameActive = true;
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 10);
            
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                cell.textContent = '?';
                cell.classList.add('hidden-value');
            });
            
            document.getElementById('gameToggle').textContent = 'Stop Spillet';
            document.getElementById('gameInputGroup').classList.add('active');
            document.getElementById('answer').disabled = false;
            generateQuestion();
        }

        function stopGame() {
            if (!gameActive) return;
            gameActive = false;
            clearInterval(timerInterval);
            
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                if (cell.textContent === '?') {
                    cell.classList.add('hidden-value');
                }
                cell.classList.remove('solved', 'correct', 'incorrect');
            });
            
            document.getElementById('gameInputGroup').classList.remove('active');
            document.getElementById('question').textContent = '';
            document.getElementById('answer').value = '';
            document.getElementById('answer').disabled = true;
            document.getElementById('feedback').textContent = 'Spillet er stoppet';
        }

        function updateTimer() {
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const milliseconds = Math.floor((elapsed % 1000) / 10); // Get 2 digits of milliseconds
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;
        }

        function toggleCells() {
            const cells = document.querySelectorAll('.cell');
            cellsVisible = !cellsVisible;
            cells.forEach(cell => {
                if (!cell.classList.contains('solved')) {
                    cell.textContent = cellsVisible ? cell.getAttribute('data-value') : '?';
                    cell.classList.toggle('hidden-value', !cellsVisible);
                }
            });
        }

        function generateQuestion() {
            if (!gameActive) return;
            const selectedValues = Array.from(document.querySelectorAll('.table-checkbox:checked')).map(cb => parseInt(cb.value, 10));
            const unsolvedCells = [];
            
            selectedValues.forEach(num1 => {
                for (let col = 1; col <= 10; col++) {
                    const cell = document.querySelector(`#multiplicationTable tbody tr:nth-child(${num1}) td:nth-child(${col + 1})`);
                    if (cell && !cell.classList.contains('solved')) {
                        unsolvedCells.push({ 
                            row: num1,     // Rækken er den valgte talrække
                            col: col + 1,  // Kolonnen (+1 for at kompensere for th)
                            num1: col,     // Første faktor (fra kolonnen)
                            num2: num1     // Anden faktor (fra rækken)
                        });
                    }
                }
            });

            if (unsolvedCells.length === 0) {
                const finalTime = document.getElementById('timer').textContent;
                document.getElementById('completionSound').play();
                showAchievementBanner(`Fantastisk! Du klarede det på ${finalTime}!`);
                fireConfetti();
                
                // Update UI for completion state
                document.getElementById('gameInputGroup').classList.remove('active');
                document.getElementById('answer').value = '';
                document.getElementById('answer').disabled = true;
                document.getElementById('gameToggle').textContent = 'Start Nyt Spil';
                document.getElementById('feedback').textContent = `Alle opgaver er løst! Din tid: ${finalTime}`;
                
                gameActive = false;
                clearInterval(timerInterval);
                return;
            }

            const randomIndex = Math.floor(Math.random() * unsolvedCells.length);
            currentQuestion = unsolvedCells[randomIndex];
            currentQuestion.answer = currentQuestion.num1 * currentQuestion.num2;
            document.getElementById('question').textContent = `${currentQuestion.num1} x ${currentQuestion.num2} = `;
            document.getElementById('answer').value = '';
            document.getElementById('answer').disabled = false;
            document.getElementById('feedback').textContent = '';
            document.getElementById('answer').focus();
        }

        // Add sound management
        let lastSoundTime = 0;
        const SOUND_COOLDOWN = 200; // Minimum time between sounds in milliseconds

        // Modify sound handling to be non-blocking
        function playSound(soundId) {
            const sound = document.getElementById(soundId);
            if (sound) {
                sound.currentTime = 0;
                sound.volume = 0.3; // Lower volume for less intrusive feedback
                const playPromise = sound.play();
                if (playPromise) {
                    playPromise.catch(() => {}); // Ignore any play errors
                }
            }
        }

        function checkAnswer() {
            if (!gameActive) return;
            const userAnswer = parseInt(document.getElementById('answer').value, 10);
            const cell = document.querySelector(`#multiplicationTable tbody tr:nth-child(${currentQuestion.row}) td:nth-child(${currentQuestion.col})`);
            
            if (userAnswer === currentQuestion.answer) {
                // Update UI immediately
                cell.textContent = currentQuestion.answer;
                cell.classList.remove('hidden-value', 'incorrect');
                cell.classList.add('correct', 'solved');
                document.getElementById('answer').value = '';

                // Play sound in background
                playSound('correctSound');

                // Create particles without blocking
                requestAnimationFrame(() => {
                    const rect = cell.getBoundingClientRect();
                    for (let i = 0; i < 5; i++) {
                        createNumberParticle(
                            rect.left + rect.width / 2,
                            rect.top + rect.height / 2,
                            userAnswer
                        );
                    }
                });

                // Generate next question immediately
                generateQuestion();
            } else {
                cell.classList.add('incorrect');
                setTimeout(() => cell.classList.remove('incorrect'), 500);
                document.getElementById('answer').select();
            }
        }

        // Add input handling optimization
        document.getElementById('answer').addEventListener('input', function(e) {
            if (this.value.length >= 2) { // Auto-submit for 2 or more digits
                checkAnswer();
            }
        });

        function handleKeyDown(event) {
            if (event.key === 'Enter') {
                checkAnswer();
            }
        }

        // Add new function for number particles
        function createNumberParticle(x, y, number) {
            const particle = document.createElement('div');
            particle.textContent = number;
            particle.style.cssText = `
                position: fixed;
                left: ${x}px;
                top: ${y}px;
                font-size: 24px;
                color: var(--success-color);
                pointer-events: none;
                z-index: 1000;
            `;
            document.body.appendChild(particle);

            const angle = Math.random() * Math.PI * 2;
            const velocity = 2 + Math.random() * 2;
            let opacity = 1;

            function animate() {
                const dx = Math.cos(angle) * velocity;
                const dy = Math.sin(angle) * velocity - 2; // Add gravity
                x += dx;
                y += dy;
                opacity -= 0.02;

                particle.style.transform = `translate(${x}px, ${y}px)`;
                particle.style.opacity = opacity;

                if (opacity > 0) {
                    requestAnimationFrame(animate);
                } else {
                    particle.remove();
                }
            }
            animate();
        }

        function showAchievementBanner(message) {
            const banner = document.createElement('div');
            banner.className = 'achievement-banner';
            banner.textContent = message;
            document.body.appendChild(banner);
            
            setTimeout(() => banner.classList.add('show'), 100);
            setTimeout(() => {
                banner.classList.remove('show');
                setTimeout(() => banner.remove(), 500);
            }, 3000);
        }

        // Add new function for cell click handling
        function initializeCellClicks() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                cell.addEventListener('click', () => {
                    if (!gameActive && !cell.classList.contains('solved')) {
                        if (cell.textContent === '?') {
                            cell.textContent = cell.getAttribute('data-value');
                            cell.classList.remove('hidden-value');
                        } else {
                            cell.textContent = '?';
                            cell.classList.add('hidden-value');
                        }
                    }
                });
            });
        }

        // Remove or modify initializeTable to not hide cells initially
        function initializeTable() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                cell.textContent = cell.getAttribute('data-value'); // Show values initially
                cell.classList.remove('hidden-value'); // Ensure cells are visible
            });
            cellsVisible = true; // Match the visible state
        }

        function fireConfetti() {
            function createFirework() {
                const colors = ['#6C63FF', '#FF6B6B', '#4CAF50', '#FDD835'];
                
                // Launch position (random along bottom)
                const startX = 0.1 + Math.random() * 0.8; // 10% to 90% of screen width
                
                // First launch the firework up
                confetti({
                    particleCount: 1,
                    startVelocity: 60,
                    gravity: 1,
                    spread: 0,
                    origin: { x: startX, y: 1 },
                    colors: [colors[Math.floor(Math.random() * colors.length)]],
                    ticks: 200,
                    scalar: 1
                });

                // Then create the explosion
                setTimeout(() => {
                    confetti({
                        particleCount: 100,
                        startVelocity: 30,
                        gravity: 0.5,
                        spread: 360,
                        origin: { x: startX, y: 0.5 },
                        colors: colors,
                        ticks: 200,
                        scalar: 1.2,
                        shapes: ['circle']
                    });
                }, 1000);
            }

            // Launch multiple fireworks with slight delays
            let fireworkCount = 5;
            for(let i = 0; i < fireworkCount; i++) {
                setTimeout(createFirework, i * 600);
            }
        }

        // Initialize cell clicks when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeTable();
            initializeCellClicks();
        });
    </script>
</body>
</html>